# .github/workflows/pr-checks.yml
#
# This workflow runs on every Pull Request.
# It performs static analysis, linting, and scanning on the source code
# *before* any artifacts are built. This is the "shift left" security
# in action, catching issues before they are merged.

name: PR Security & Lint Checks

on:
  pull_request:
    branches: [ "main" ] # Or your default branch
  workflow_dispatch: # Allows manual triggering

jobs:
  security-checks:
    name: Security & Linting
    runs-on: ubuntu-latest

    # These permissions are needed for CodeQL to function.
    # Gitleaks also uses the security-events to upload SARIF results.
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      # --- 1. Checkout Code ---
      # Gitleaks needs the full history to scan for secrets,
      # so we set fetch-depth: 0 (which means "all history").
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- 2. SAST (Static Application Security Testing) ---
      # Run CodeQL to find vulnerabilities in the code itself.
      # This finds issues like SQL injection, XSS, etc.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: 'python' # Specify the language to analyze

      # Add your project's build steps here if it's a compiled language (e.g., Go, Java)
      # - name: Autobuild
      #   uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

      # --- 3. Secret Scanning ---
      # Run Gitleaks to find any hardcoded secrets.
      - name: Run Gitleaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 4. Dockerfile Linting ---
      # Run Hadolint to check the Dockerfile for best practices
      # and common security misconfigurations (e.g., running as root).
      - name: Run Hadolint Dockerfile Linter
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: ./Dockerfile # Path to your Dockerfile

# -------------------------------------------
      # 4. Filesystem Vulnerability Scanning with Trivy
      # -------------------------------------------

      # This first step runs Trivy, formats as SARIF, and uploads to the
      # GitHub Security tab. We don't fail the build here, we just report.
      - name: Run Trivy filesystem scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs' # Scan the filesystem
          scan-ref: '.'   # Scan the current directory
          format: 'sarif'
          output: 'trivy-fs.sarif'
          # Don't fail the build here; we just want the report.
          # The next step will handle failures.
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH This second step runs Trivy again but formats as a table.'
      # This provides a clean summary in the build log AND will
      # fail the build if CRITICAL vulnerabilities are found.
      - name: Run Trivy filesystem scan (Table)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table' # Output a table to the build log
          # This step WILL fail the build on CRITICAL issues.
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL'
          scanners: 'vuln,config' # Scan for vulnerabilities and misconfigs
